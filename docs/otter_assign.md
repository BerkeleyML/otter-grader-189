# Distributing Assignments

<!-- The documentation for otter-assign is forked from the docs for jassign: https://github.com/okpy/jassign/blob/master/docs/notebook-format.md -->

Otter ships with an assignment development and distribution tool called otter-assign, an Otter-compliant fork of [jassign](https://github.com/okpy/jassign) that was designed for OkPy. otter-assign allows instructors to create assignments by writing questions, prompts, solutions, and public and private tests all in a single notebook, which is then parsed and broken down into student and autograder versions.

## Notebook Format

Otter's notebook format groups prompts, solutions, and tests together into prompts. Autograder tests are specified as cells in the notebook and their output is used as the expected output of the autograder when genreating tests. Each question has metadata, expressed in a code block in YAML format when the question is declared. Tests generated by otter-assign follow the [Otter-compliant OK format](test_files.md).

**Note:** otter-assign is also backwards-compatible with jassign-formatted notebooks. To use jassign format with otter-assign, specify the `--jassign` flag in your call to `otter assign`. While the formats are very similar, jassign's format has some key differences to the otter-assign format. For more information about frmatting notebooks for jassign, see [its documentation](https://github.com/okpy/jassign/blob/master/docs/notebook-format.md).

### Autograded Questions

Here is an example question in an otter-assign-formatted notebook:

![](images/assign_sample_question.png)

For code questions, a question is a description *Markdown* cell, followed by a prompt *code* cell, a solution *code* cell, and zero or more test *code* cells. The description cell must contain a code block (enclosed in triple backticks <code>\`\`\`</code>) that begins with `BEGIN QUESTION` on its own line, followed by YAML that defines metadata associated with the question.

The rest of the code block within the description cell must be YAML-formatted with the following fields (in any order):

* `name` (required) - a string identifier that is a legal file name (without an extension)
* `manual` (optional) - a boolean (default `False`); whether to include the response cell in a PDF for manual grading
* `points` (optional) - a number (default `1`); how many points the question is worth

As an example, the question metadata below indicates an autograded question `q1` worth 1 point.

````
```
BEGIN QUESTION
name: q1
manual: false
```
````

The prompt cell must always appear directly below the description cell (where the question metadata is defined), and below that should be a solution cell. Solution cells are indicated by putting `## Solution ##` on the first line of the cell (case insensitive).

The test cells are any code cells following the solution cell that begin with the comment `## Test ##` or `## Hidden Test ##` (case insensitive). A `Test` is distributed to students so that they can validate their work. A `Hidden Test` is not distributed to students, but is used for scoring their work.

**Note:** Currently, the conversion to OK format does not handle multi-line tests if any line but the last one generates output. So, if you want to print
twice, make two separate test cells instead of a single cell with:

```python
print(1)
print(2)
```

### Manually Graded Questions

otter-assign also supports manually-graded questions using a similar specification to the one described above. To indicate a manually-graded question, set `manual: true` in the question metadata. A manually-graded question is defined by three parts:

* A question cell with metadata
* (Optional:) A prompt cell
* A solution cell

Manually-graded solution cells have two formats:

* If a code cell, they can be delimited by the `## Solution ##` comment as above.
* If a Markdown cell, the start of any line must match the regex `(<strong>|\*{2})solution:?(<\/strong>|\*{2})`.

The latter means that as long as one of the lines in the cell starts with `SOLUTION` (case insensitive, with or without a colon `:`) in boldface, the cell is considered a solution cell. If there is a prompt cell for manually-graded questions (i.e. a cell between the question cell and solution cell), then this prompt is included in the output. If none is present, otter-assign automatically adds a Markdown cell with the contents `_Type your answer here, replacing this test._`

Manually graded questions are automatically enclosed in `<!-- BEGIN QUESTION -->` and `<!-- END QUESTION -->` tags by otter-assign so that only these questions are exported to the PDF when filtering is turned on (the default). In the autograder notebook, this includes the question cell, prompt cell, and solution cell. In the student notebook, this includes only the question and prompt cells. The `<!-- END QUESTION -->` tag is automatically inserted at the top of the next cell if it is a Markdown cell or in a new Markdown cell before the next cell if it is not.

An example of a manually-graded code question:

![](images/assign_sample_code_manual.png)

An example of a manually-graded written question (with no prompt):

![](images/assign_sample_written_manual.png)

An example of a manuall-graded written question with a custom prompt:

![](images/assign_sample_written_manual_with_prompt.png)

## Usage and Output

otter-assign is called used the `otter assign` command. This command takes in two required arguments.

```
$ otter assign --help
usage: otter assign [-h] [--no-export-cell] [--no-run-tests] [--no-init-cell]
                    [--no-check-all] [--no-filter]
                    [--instructions INSTRUCTIONS]
                    master result [files [files ...]]

Create distribution versions of otter-assign formatted notebook

positional arguments:
  master                Notebook with solutions and tests.
  result                Directory containing the result.
  files                 Other support files needed for distribution (e.g. .py
                        files, data files)

optional arguments:
  -h, --help            show this help message and exit
  --no-export-cell      Don't inject an export cell into the notebook
  --no-run-tests        Don't run tests.
  --no-init-cell        Don't automatically generate an Otter init cell
  --no-check-all        Don't automatically add a check_all cell
  --no-filter           Don't filter the PDF.
  --instructions INSTRUCTIONS
                        Additional submission instructions for students
```

The first is `master`, the path to the master notebook (the one formatted as described above), and the second is `result`, the path at which output shoud be written. The optional `files` argument takes an arbitrary number of paths to files that should be shipped with notebooks (e.g. data files, images, Python executables).

The default behavior of otter-assign is to do the following:

1. Filter test cells from the master notebook and write these to test files
2. Add Otter initialization, export, and `Notebook.check_all` cells
3. Clear outputs and write questions (with metadata hidden), prompts, and solutions to a notebook in a new `autograder` directory
4. Write *all* tests to `autograder/tests`
5. Copy autograder notebook with solutions removed into a new `student` directory
6. Write *public* tests to `student/tests`
7. Copy `files` into `autograder` and `student` directories
8. Run all tests in `autograder/tests` on the solutions notebook to ensure they pass

The behaviors described in step 2 can be overridden using the optional arguments described in the help specification.

**An important note:** make sure that you *run all cells* in the master notebook and save it *with the outputs* so that otter-assign can generate the test files based on these outputs. The outputs will be cleared in the copies generated by otter-assign.

### Export Formats and Flags

By default, otter-assign adds an initialization cell at the *top* of the notebook with the contents

```python
# Initialize Otter
import otter
grader = otter.Notebook()
```

To prevent this behavior, add the `--no-init-cell` flag.

otter-assign also automatically adds a check-all cell and an export cell to the end of the notebook. The check-all cells consist of a Markdown cell:

```
To double-check your work, the cell below will rerun all of the autograder tests.
```

and a code cell that calls `otter.Notebook.check_all`:

```python
grader.check_all()
```

The export cells consist of a Markdown cell:

```
## Submission

Make sure you have run all cells in your notebook in order before running the cell below, so that all images/graphs appear in the output. **Please save before submitting!**
```

and a code cell that calls `otter.Notebook.export` with HTML comment filtering:

```python
# Save your notebook first, then run this cell to export.
grader.export("/path/to/notebook.ipynb")
```

To prevent the inclusion of a check-all cell, use the `--no-check-all` flag. To prevent cell filtering in the export cell, use the `--no-filter` flag. To remove the export cells entirely, use the `--no-export-cell` tag. If you have custom instructions for submission that you want to add to the export cell, pass them to the `--instructions` flag.

**Note:** otter-assign currently only supports [HTML comment filtering](pdfs.md). This means that if you have other cells you want included in the export, you must delimit them using HTML comments, not using cell tags.

### otter-assign Example

Consider the directory stucture below, where `hw00/hw00.ipynb` is an otter-assign-formatted notebook.

```
| hw00
  | - hw00.ipynb
  | - data.csv
```

To generate the distribution versions of `hw00.ipynb` (after `cd`ing into `hw00`), I would run

```
otter assign hw00.ipynb dist
```

This will create a new folder called `dist` with `autograder` and `student` as subdirectories, as described above.

```
| hw00
  | - hw00.ipynb
  | - data.csv
  | dist
    | autograder
      | - hw00.ipynb
      | tests
        | - q1.py
        | - q2.py
        ...
    | student
      | - hw00.ipynb
      | tests
        | - q1.py
        | - q2.py
        ...
```

If I had wanted to include `data.csv` in the distribution folders, I would change my call to

```
otter assign hw00.ipynb dist data.csv
```

The resulting directory structure would be:

```
| hw00
  | - hw00.ipynb
  | - data.csv
  | dist
    | autograder
      | - data.csv
      | - hw00.ipynb
      | tests
    | student
      | - data.csv
      | - hw00.ipynb
      | tests
```

In generating the distribution versions, I can prevent otter-assign from rerunning the tests using the `--no-run-tests` flag:

```
otter assign --no-run-tests hw00.ipynb dist data.csv
```

If I wanted no initialization cell and no cell filtering in the export cell, I would run

```
otter assign --no-init-cell --no-filtering hw00.ipynb dist data.csv
```
